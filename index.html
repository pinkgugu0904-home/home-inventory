<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Inventory｜新增物品</title>

  <!-- 不讓搜尋引擎收錄 -->
  <meta name="robots" content="noindex, nofollow" />

  <style>
    :root { --gap: 14px; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      margin: 0; background:#f6f7fb; color:#111;
    }
    .wrap{
      max-width: 880px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    .card{
      background:#fff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
      padding: 16px;
    }
    h1{ font-size: 20px; margin: 6px 0 4px; }
    .sub{ font-size: 13px; color:#555; margin: 0 0 16px; line-height: 1.6; }

    /* 手機優先，一欄；桌機兩欄 */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
    }
    @media (min-width: 720px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .span-2{ grid-column: span 2; }
    }

    label{
      display:block;
      font-weight: 700;
      font-size: 13px;
      margin: 2px 0 6px;
    }
    input, select, textarea{
      width: 100%;
      box-sizing: border-box;
      padding: 11px 12px;
      border: 1px solid #d9dce6;
      border-radius: 12px;
      font-size: 15px;
      background: #fff;
      outline: none;
    }
    input:focus, select:focus, textarea:focus{
      border-color:#7a90ff;
    }
    textarea{ min-height: 92px; resize: vertical; }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      margin-top: 18px;
    }
    button{
      width: 100%;
      padding: 12px 14px;
      border: 0;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
    }
    .btn{
      background:#111;
      color:#fff;
    }
    .btn:disabled{
      opacity: .55;
      cursor:not-allowed;
    }
    .ghost{
      background:#fff;
      border:1px solid #d9dce6;
      color:#111;
      font-weight:700;
    }
    .hint{
      font-size: 12px;
      color:#666;
      margin-top: 6px;
      line-height:1.45;
    }
    .small{
      font-size: 12px;
      color:#666;
      margin-top: 6px;
    }
    .toast{
      margin-top: 12px;
      font-size: 13px;
      padding: 10px 12px;
      border-radius: 12px;
      display:none;
      white-space: pre-line;
    }
    .ok{
      background:#ecfff1;
      border:1px solid #bfe9c8;
      color:#0c5a1a;
    }
    .err{
      background:#fff1f1;
      border:1px solid #f1b8b8;
      color:#7a0b0b;
    }
    .req::after{
      content:" *";
      color:#d40000;
    }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background:#f1f3ff;
      color:#2a3cff;
      font-weight:700;
      font-size: 12px;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>家庭物品新增（Home Inventory）</h1>
      <p class="sub">
        記錄物品、分類與存放位置，避免下次翻箱倒櫃。<br>
        照片會在上傳前自動縮小（更穩、也更省 Google 空間）。
      </p>

      <form id="inventoryForm">
        <div class="grid">

          <div class="span-2">
            <label class="req">物品名稱</label>
            <input name="item_name" placeholder="例如：聖誕樹、備用電池、Kitty 收納盒" required />
          </div>

          <div>
            <label>購買日期</label>
            <input name="purchase_date" type="date" />
          </div>

          <div>
            <label>價格</label>
            <input name="price" type="number" inputmode="numeric" placeholder="例如：399" />
          </div>

          <div>
            <label>產品分類（自由）</label>
            <input name="category" placeholder="例如：節慶用品 / 文具 / 清潔用品" />
          </div>

          <div>
            <label>分類第一層</label>
            <input name="category_level_1" placeholder="例如：生活用品" />
          </div>

          <div>
            <label>分類第二層</label>
            <input name="category_level_2" placeholder="例如：清潔用品" />
          </div>

          <div>
            <label>取得來源</label>
            <input name="source" placeholder="例如：全聯 / 網購 / 親友贈送 / 公司發的" />
          </div>

          <div>
            <label>存放位置</label>
            <input name="storage_location" placeholder="例如：A1（主臥衣櫃上層）" />
          </div>

          <div class="span-2">
            <label>目前狀態</label>
            <select name="status">
              <option value="in_use">在用</option>
              <option value="almost_used_up">快用完</option>
              <option value="used_up">已用完 / 已吃完</option>
              <option value="discarded">已丟棄</option>
            </select>
          </div>

          <div class="span-2">
            <label>備註</label>
            <textarea name="notes" placeholder="例如：含裝飾 / 備用零件 / 放在透明收納箱"></textarea>
          </div>

          <div class="span-2">
            <label>照片（可多張）</label>
            <input id="photos" type="file" accept="image/*" multiple />
            <div class="hint">
              建議一次 1～3 張。照片會自動縮到最長邊 1280px、品質 0.7。
            </div>
            <div id="photoInfo" class="small"></div>
          </div>

          <div class="span-2">
            <span class="pill">自動縮圖已啟用</span>
          </div>

        </div>

        <div class="row">
          <button class="ghost" type="reset">清空</button>
          <button id="submitBtn" class="btn" type="submit">送出儲存</button>
        </div>

        <div id="toast" class="toast"></div>
      </form>
    </div>
  </div>

  <script>
    // ✅ 你最新部署的 Apps Script Web App
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzW7tDXZ5HOyNE6l65hYGifnvWecEPgKpi4GGEdzbOnTnzWxpvzljqo8EkUtiFmAw5w6A/exec";

    // 縮圖參數（你想更省空間可以改：maxSize=1024、quality=0.65）
    const RESIZE_MAX = 1280;
    const JPEG_QUALITY = 0.7;
    const MAX_FILES = 5; // 最多上傳 5 張，避免太重

    const form = document.getElementById("inventoryForm");
    const btn  = document.getElementById("submitBtn");
    const toast = document.getElementById("toast");
    const photoInput = document.getElementById("photos");
    const photoInfo = document.getElementById("photoInfo");

    function showToast(type, msg){
      toast.className = "toast " + (type === "ok" ? "ok" : "err");
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display = "none", 4500);
    }

    function bytesToHuman(n){
      if (!Number.isFinite(n)) return "";
      const units = ["B","KB","MB","GB"];
      let u = 0, v = n;
      while (v >= 1024 && u < units.length-1){ v /= 1024; u++; }
      return `${v.toFixed(v >= 10 || u === 0 ? 0 : 1)} ${units[u]}`;
    }

    function fileToBase64Resized(file, maxSize = 1280, quality = 0.7) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = e => {
          img.onload = () => {
            let { width, height } = img;

            // 等比例縮放到最長邊 maxSize
            if (width > height && width > maxSize) {
              height = Math.round(height * (maxSize / width));
              width = maxSize;
            } else if (height > maxSize) {
              width = Math.round(width * (maxSize / height));
              height = maxSize;
            }

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            // 轉成 JPEG（統一格式、好壓縮）
            const dataUrl = canvas.toDataURL("image/jpeg", quality);
            const base64 = String(dataUrl).split(",")[1] || "";
            resolve({ base64, width, height, mime: "image/jpeg" });
          };

          img.onerror = reject;
          img.src = e.target.result;
        };

        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // 顯示選取照片資訊
    photoInput.addEventListener("change", () => {
      const files = Array.from(photoInput.files || []);
      if (files.length === 0) {
        photoInfo.textContent = "";
        return;
      }
      const total = files.reduce((sum,f)=>sum + (f.size||0), 0);
      photoInfo.textContent = `已選 ${files.length} 張（原始合計約 ${bytesToHuman(total)}），上傳前會自動縮圖。`;
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      btn.disabled = true;
      btn.textContent = "送出中…";

      try {
        const fd = new FormData(form);

        const files = Array.from(photoInput?.files || []).slice(0, MAX_FILES);

        if (files.length > 0) {
          const photosPayload = [];
          for (const f of files) {
            // 自動縮圖 → base64
            const r = await fileToBase64Resized(f, RESIZE_MAX, JPEG_QUALITY);
            photosPayload.push({
              name: f.name,
              type: r.mime,          // 會是 image/jpeg
              dataBase64: r.base64
            });
          }
          fd.append("photos_json", JSON.stringify(photosPayload));
        }

        const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
        const text = await res.text();

        let data = null;
        try { data = JSON.parse(text); } catch(_) {}

        if (!res.ok) {
          showToast("err", `HTTP ${res.status}\n${text.slice(0,200)}`);
        } else if (!data) {
          // 常見：權限不對會回登入頁 HTML
          showToast("err", "回傳不是 JSON（可能是部署權限不是『任何人』）\n" + text.slice(0,200));
        } else if (!data.ok) {
          showToast("err", "後端錯誤：\n" + (data.error || "unknown"));
        } else {
          showToast("ok", `已儲存 ✅（照片 ${data.photoCount || 0} 張）`);
          form.reset();
          photoInfo.textContent = "";
        }
      } catch (err) {
        showToast("err", "送出失敗：\n" + (err?.message || String(err)));
      } finally {
        btn.disabled = false;
        btn.textContent = "送出儲存";
      }
    });
  </script>
</body>
</html>
